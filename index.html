<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mes Scénarios</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; max-width: 900px }
    h1 { margin-bottom: 8px }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center }
    input, textarea, button { font: inherit }
    input[type="text"] { width: 320px; padding: 8px }
    textarea { width: 100%; min-height: 140px; padding: 10px; resize: vertical }
    button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; background: #fff }
    button.primary { background: #0ea5e9; border-color: #0ea5e9; color: #fff }
    button.danger  { background: #ef4444; border-color: #ef4444; color: #fff }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; margin: 14px 0 }
    .list { display: grid; gap: 12px }
    .meta { font-size: 12px; color: #6b7280 }
    .toolbar { display:flex; gap:8px; flex-wrap: wrap; align-items:center; margin: 8px 0 16px }
    .spacer { flex: 1 }
    .muted { color:#6b7280 }
  </style>
</head>
<body>
  <h1>📚 Mes Scénarios</h1>
  <p class="muted">Tout est enregistré automatiquement dans ton navigateur (localStorage).</p>

  <div class="card">
    <div class="row">
      <input id="title" type="text" placeholder="Titre du scénario (ex : Scène 1)" />
      <button id="saveBtn" class="primary">💾 Enregistrer</button>
      <button id="newBtn">🆕 Nouveau</button>
    </div>
    <textarea id="content" placeholder="Décris ton scénario ici..."></textarea>
    <div class="meta" id="status">Brouillon non enregistré</div>
  </div>

  <div class="toolbar">
    <input id="search" type="text" placeholder="Rechercher un titre/texte…" />
    <div class="spacer"></div>
    <button id="exportBtn">⬇️ Exporter (JSON)</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
    <button id="importBtn">⬆️ Importer</button>
    <button id="clearAllBtn" class="danger">🗑️ Tout effacer</button>
  </div>

  <div class="list" id="list"></div>

<script>
(() => {
  const KEY = 'scenarios_v1';
  const DRAFT_KEY = 'scenarios_draft_v1';
  /** @type {{id:string,title:string,content:string,updated:number}[]} */
  let scenarios = load(KEY, []);
  let currentId = null; // id du scénario en cours d’édition

  // Helpers
  function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback }catch{ return fallback } }
  function now(){ return new Date().toISOString(); }
  function fmt(t){ const d = new Date(t); return d.toLocaleString() }
  function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36) }

  // UI elements
  const titleEl   = document.getElementById('title');
  const contentEl = document.getElementById('content');
  const statusEl  = document.getElementById('status');
  const listEl    = document.getElementById('list');
  const searchEl  = document.getElementById('search');

  // Rendu de la liste
  function renderList() {
    const q = searchEl.value.toLowerCase();
    listEl.innerHTML = '';
    scenarios
      .slice() // copie
      .sort((a,b)=>b.updated - a.updated) // plus récents en premier
      .filter(s => s.title.toLowerCase().includes(q) || s.content.toLowerCase().includes(q))
      .forEach(s => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <strong>${escapeHtml(s.title || '(Sans titre)')}</strong>
            <span class="meta">Modifié: ${fmt(s.updated)}</span>
          </div>
          <p class="muted" style="white-space:pre-line; margin-top:8px">${escapeHtml(snippet(s.content))}</p>
          <div class="row" style="margin-top:8px">
            <button data-action="edit" data-id="${s.id}">✏️ Modifier</button>
            <button data-action="duplicate" data-id="${s.id}">📄 Dupliquer</button>
            <button data-action="delete" data-id="${s.id}" class="danger">🗑️ Supprimer</button>
          </div>
        `;
        listEl.appendChild(div);
      });
  }

  function escapeHtml(str=''){ return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
  function snippet(str='', n=180){ return str.length>n ? str.slice(0,n) + '…' : str }

  // Charger un scénario dans l’éditeur
  function loadIntoEditor(s){
    currentId = s?.id ?? null;
    titleEl.value = s?.title ?? '';
    contentEl.value = s?.content ?? '';
    statusEl.textContent = currentId ? `Édite: ${s.title || '(Sans titre)'} — Dernière modif: ${fmt(s.updated)}` : 'Brouillon non enregistré';
  }

  // Nouveau brouillon
  document.getElementById('newBtn').onclick = () => loadIntoEditor(null);

  // Enregistrer
  document.getElementById('saveBtn').onclick = () => {
    const title = titleEl.value.trim();
    const content = contentEl.value.trim();
    if (!title && !content) { alert('Rien à enregistrer 😅'); return; }

    if (currentId) {
      const idx = scenarios.findIndex(s => s.id === currentId);
      if (idx !== -1) {
        scenarios[idx] = { ...scenarios[idx], title, content, updated: Date.now() };
      }
    } else {
      scenarios.push({ id: uid(), title, content, updated: Date.now() });
    }
    save(KEY, scenarios);
    localStorage.removeItem(DRAFT_KEY);
    loadIntoEditor(null);
    renderList();
  };

  // Actions de la liste
  listEl.addEventListener('click', (e) => {
    const btn = e.target.closest('button'); if (!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    const s = scenarios.find(x => x.id === id);
    if (!s) return;

    if (action === 'edit') {
      loadIntoEditor(s);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (action === 'delete') {
      if (confirm('Supprimer ce scénario ?')) {
        scenarios = scenarios.filter(x => x.id !== id);
        save(KEY, scenarios);
        if (currentId === id) loadIntoEditor(null);
        renderList();
      }
    } else if (action === 'duplicate') {
      scenarios.push({ id: uid(), title: s.title + ' (copie)', content: s.content, updated: Date.now() });
      save(KEY, scenarios); renderList();
    }
  });

  // Recherche
  searchEl.addEventListener('input', renderList);

  // Auto-brouillon local toutes les 800 ms
  let draftTimer;
  function scheduleDraftSave(){
    clearTimeout(draftTimer);
    draftTimer = setTimeout(()=>{
      const draft = { title: titleEl.value, content: contentEl.value, when: now() };
      save(DRAFT_KEY, draft);
      statusEl.textContent = `Brouillon enregistré localement (${new Date().toLocaleTimeString()})`;
    }, 800);
  }
  titleEl.addEventListener('input', scheduleDraftSave);
  contentEl.addEventListener('input', scheduleDraftSave);

  // Restaurer un brouillon si présent
  (function restoreDraft(){
    const d = load(DRAFT_KEY, null);
    if (d && (!titleEl.value && !contentEl.value)) {
      titleEl.value = d.title || '';
      contentEl.value = d.content || '';
      statusEl.textContent = `Brouillon restauré (${fmt(d.when)})`;
    }
  })();

  // Export / Import / Tout effacer
  document.getElementById('exportBtn').onclick = () => {
    const blob = new Blob([JSON.stringify(scenarios, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: 'scenarios_backup.json' });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  };

  document.getElementById('importBtn').onclick = () => document.getElementById('importFile').click();
  document.getElementById('importFile').addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const text = await file.text();
    try {
      const data = JSON.parse(text);
      if (!Array.isArray(data)) throw new Error('format invalide');
      scenarios = data.map(x => ({ id: x.id || uid(), title: x.title || '', content: x.content || '', updated: x.updated || Date.now() }));
      save(KEY, scenarios); renderList();
      alert('Import terminé ✔️');
    } catch(err) {
      alert('Fichier invalide : ' + err.message);
    } finally {
      e.target.value = '';
    }
  });

  document.getElementById('clearAllBtn').onclick = () => {
    if (confirm('Supprimer TOUS les scénarios ? (irréversible)')) {
      scenarios = []; save(KEY, scenarios); renderList(); loadIntoEditor(null);
    }
  };

  // Démarrage
  renderList();
})();
</script>
</body>
</html>
